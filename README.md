## Django/postgres skeleton app overview

Two docker containers: `django` running django `pgdb` running postgres.

The site isn't doing anything interesting but when it's running it should be at http://127.0.0.1:8000

## Prerequisites

* Download and install docker [Docker](https://www.docker.com/)

## Setup

In the "core" folder there is a file `example.env`.
Copy this into a new `.env` file and fill it in (this .env file must also be in the "core" folder).
`DJANGO_SECRET` should be a value you get from running `python gen_random_key.py`
`DB_PASSWORD` can be whatever you want.

## Initial load of CT.gov data

1. Download `.zip` from [https://aact.ctti-clinicaltrials.org/snapshots](https://aact.ctti-clinicaltrials.org/snapshots)
2. Unzip into `data` folder (`unzip <filename.zip> -d data`)
3. Start running the docker containers `docker-compose up`. The first time you
run this it will take a LONG time! After the first time, much of the build
will be cached and it will not take so long.
4. Connect to postgres container. `docker exec -it --user postgres pgdb /bin/bash`
5. Create the database `createdb aact`
6. Restore the database from the `.dmp` file. `pg_restore -e -v -O -x -d aact --no-owner data/postgres_data.dmp`
7. Start psql `psql`
8. You should see the `postgres=#` prompt.
9. Add ctgov schema to pSQL search path `alter role postgres in database aact set search_path = ctgov, public;`
10. Connect to the aact database: `\c aact`
11. If you run `\dt` you should see something like this...

```
                  List of relations
 Schema |            Name            | Type  |  Owner   
--------+----------------------------+-------+----------
 ctgov  | baseline_counts            | table | postgres
 ctgov  | baseline_measurements      | table | postgres
 ctgov  | brief_summaries            | table | postgres
 ctgov  | browse_conditions          | table | postgres
 ctgov  | browse_interventions       | table | postgres
 ctgov  | calculated_values          | table | postgres
 ctgov  | categories                 | table | postgres
 ctgov  | central_contacts           | table | postgres
 ctgov  | conditions                 | table | postgres
 ctgov  | countries                  | table | postgres
```

## Turn the docker containers on/off

	docker-compose up
	docker-compose down

## Overview of Files

	.
	├── README.md
	├── core 					
	│   ├── Dockerfile
	│   ├── core
	│   │   ├── __init__.py
	│   │   ├── asgi.py
	│   │   ├── settings.py
	│   │   ├── urls.py
	│   │   └── wsgi.py
	│   ├── example.env
	│   ├── manage.py
	│   ├── requirements.in
	│   └── requirements.txt
	├── docker-compose.yml
	└── gen_random_key.py
	
`core` - Django project files

`core/Dockerfile` - A Dockerfile that defines the base build for the django Docker container. This does some initial setup and installation of libraries on the django build. This file is run by the `docker-compose.yml` file by this line: `build: ./core`

`docker-compose.yml` - A docker file that defines how the django and pgdb docker containers will be run together. (The pgdb doesn't have its own docker file because the base setup for the postgres container is using a predefined image from dockerhub `image: postgres` without much additional setup needed).

`core/requirements.in` - This is where you would add python libraries that you want to include in the project.

`core/requirements.txt` - This file should NOT be manually edited. This file is auto generated by a script that takes in the `requirements.in` and outputs a `requirements.txt` file with the proper versions of each library.

## Other useful commands

### Docker

`docker images` - see your docker images

`docker ps` - see your currently running docker containers

### psql

Here's a useful psql command cheat sheet: [https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546](https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546)

## Connect to the containers

### django
`docker exec -it django /bin/bash`

### pgdb
`docker exec -it pgdb /bin/bash` (note: you can only access the db as the user postges so if you connect this way you may need to switch users)

or to go straight into psql `docker exec -it pgdb psql -U postgres`
